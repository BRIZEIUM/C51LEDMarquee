#include <reg51.h>
#define LEDCharNum 18 //LEDMatrix字符个数
#define TimeCountValue 1000 //Timer 0每TimeCountValue us中断一次
#define Ld 500 //每个LED点阵字符显示Ld遍
#define fd 40 //每个LED流水灯显示fd遍
unsigned char code LEDMatrix[LEDCharNum][8] = //LED点阵字符数组
{	
	{0xFF,0xFF,0x93,0xAB,0xB3,0xFF,0xFF,0xFF},//"2",0列
	{0xFF,0xFF,0xC7,0xBB,0xC7,0xFF,0xFF,0xFF},//"0",1列
	{0xFF,0xFF,0xBB,0x83,0xBF,0xFF,0xFF,0xFF},//"1",2列
	{0xFF,0xFF,0xA3,0xAB,0xC3,0xFF,0xFF,0xFF},//"9",3列
	{0xFF,0x7F,0x97,0xE5,0x05,0x75,0x77,0x7F},//"元",4列
	{0xFF,0xBF,0xA1,0xA9,0xA9,0xA1,0xBF,0xFF},//"旦",5列
	{0xF7,0x00,0x73,0xB5,0xC0,0x95,0x71,0xF7},//"快",6列
	{0xFF,0xB3,0xD5,0x75,0x81,0xD5,0xB5,0xFF},//"乐",7列
	{0xFF,0xFF,0xFF,0xA1,0xFF,0xFF,0xFF,0xFF},//"！",8列
	{0xFB,0xFB,0xBB,0xBF,0xBF,0xBB,0xFB,0xFB}, //笑脸1
	{0xFB,0xDD,0xBB,0xBF,0xBF,0xBB,0xDD,0xFB}, //笑脸2
	{0xFB,0xFB,0xBB,0xBF,0xBF,0xBB,0xFB,0xFB}, //笑脸1
	{0xFB,0xDD,0xBB,0xBF,0xBF,0xBB,0xDD,0xFB}, //笑脸2
	{0xFB,0xFB,0xBB,0xBF,0xBF,0xBB,0xFB,0xFB}, //笑脸1
	{0xFB,0xDD,0xBB,0xBF,0xBF,0xBB,0xDD,0xFB}, //笑脸2
	{0xFB,0xDD,0xBB,0xBF,0xBF,0xBB,0xDD,0xFB}, //笑脸2
	{0xFB,0xDD,0xBB,0xBF,0xBF,0xBB,0xDD,0xFB}, //笑脸2
	{0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF}, //复位
};
unsigned char code flowLED[] = //LED流水灯数组
{
	0xFE,0xFC,0xF8,0xF0,0xE0,0xC0,0x80,0X00, //逐个点亮
	0X00,0X00,0X00,0X00,0X00, //保持全亮
	0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF, //全部熄灭
	0X88 //结束
};
unsigned char code LSelected[] = //LED点阵字符显示位选
{
	0x01, 0x02, 0x04, 0x08, 0x10, 0x20, 0x40, 0x80
};
unsigned int dLTC, dfTC; //显示扫描计数器
int dL1, dL2, df1; //数据显示下标

void initialize(void); //初始化
void settingTimer0(void); //Timer 0初始化
void delay(unsigned int ms); //毫秒级延时
void openAnm(int times); //入场动画
void display_LEDMatrix(void); //点阵字符显示
void display_flowLED(void); //流水灯显示
void timer0(void) interrupt 1 //Timer 0中断服务子程序
{
	display_LEDMatrix(); //点阵字符显示
	display_flowLED(); //流水灯显示
	TH0 = (65536 - TimeCountValue) / 256; //设置中断计数
	TL0 = (65536 - TimeCountValue) % 256;
}

//==========================
int main()
{
	initialize();
	openAnm(5);
	settingTimer0();
	while(1)
	{
	}
	
	return 0;
}
//===========================

void initialize(void)
{
	P0 = 0xFF; //列使能，低有效。 IO口初始化
	P2 = 0x00; //列数据，高有效。
	P3 = 0xFF;
	dL1 = 0; //数据显示下标复位
	dL2 = 0;
	df1 = 0;
}
void settingTimer0(void)
{
	IE = 0x82; //中断使能，Timer 0中断使能
	TMOD = 0x01; //设置Timer 0工作模式为模式1
	TH0 = (65536 - TimeCountValue) / 256; //设置中断计数
	TL0 = (65536 - TimeCountValue) % 256;
	dLTC = 0; //显示扫描计数器复位
	dfTC = 0;
	TR0 = 1; //启动Timer 0中断
}
void delay(unsigned int ms)
{
	int i, j;
	for(i = ms; i > 0; i--)
	{
		for(j = 110; j > 0; j--);
	}
}
void openAnm(int times)
{
	int i;
	for(i = 0; i < times; i++)
	{
		P3 = 0x00;
		delay(100);
		P3 = 0xFF;
		delay(20);
		
		P0 = 0X00;
		P2 = 0XFF;
		delay(30);
		P0 = 0xFF;
		P2 = 0x00;
		
		delay(850);
	}
}
void display_LEDMatrix(void)
{
	//显示
	P0 = 0xFF; //列使能，低有效。清屏
	P2 = ~LEDMatrix[dL1][dL2]; //列数据，高有效。送1列显示数据。先送数据再使能，防止残影
	P0 = ~LSelected[dL2]; //列使能，低有效。使能列
	//数据显示下标操作
	dL2++;	
	if(dL2 >= 8)
	{
		dL2 = 0;
	}
	dLTC++;
	if(dLTC >= Ld)
	{
		dL1++;
		dLTC = 0;
	}
	if(dL1 >= LEDCharNum)
	{
		dL1 = 0;
	}
}
void display_flowLED(void)
{
	//显示
	if(flowLED[df1] == 0x88)
	{
		df1 = 0;
	}
	P3 = flowLED[df1];
	//数据显示下标操作
	dfTC++;
	if(dfTC >= fd)
	{
		df1++;
		dfTC = 0;
	}
}